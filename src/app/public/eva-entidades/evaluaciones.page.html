<ion-content class="ion-padding">
  <mat-tab-group (selectedIndexChange)="onChangeTabs()">
    <mat-tab label="Evaluaciones">
      <gcm-table-top>
        <button
          mat-icon-button
          color="primary"
          style="margin: 0 10px 0 10px"
          (click)="onExportExcel()"
        >
          <mat-icon>save</mat-icon>
        </button>

        <gcm-filter-field [formControl]="filtro"></gcm-filter-field>

        <mat-paginator [pageSizeOptions]="[30]" showFirstLastButtons [hidePageSize]="true">
        </mat-paginator>
      </gcm-table-top>

      <div class="conciliaciones-datatable__table-container gcm-table__container">
        <table
          mat-table
          [dataSource]="dataSource"
          multiTemplateDataRows
          [class.d-none]="!dataSource.data.length || isLoading || !dataSource.filteredData.length"
          matSort
        >
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Cod.</th>
            <td mat-cell class="col-7-5" *matCellDef="let el">
              <div class="gcm-table__principal-column">{{ el.id }}</div>
            </td>
          </ng-container>

          <ng-container matColumnDef="tipoEval">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tip. Eval.</th>
            <td mat-cell class="col-7-5" *matCellDef="let el" (click)="clickOnConciliacion(el)">
              {{ el.tipoEval }} ({{el.tipo_evaluacion.descripcion}})
              <div class="gcm-table__subcontent">CREADA POR {{ el.nombreEvaluador }}</div>
            </td>
          </ng-container>

          <ng-container matColumnDef="nombreEvaluado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Evaluado</th>
            <td mat-cell class="col-10" *matCellDef="let el" (click)="clickOnConciliacion(el)">
              {{ el.nombreEvaluado }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr
            has-lines
            mat-row
            *matRowDef="let el; columns: displayedColumns"
            class="gcm-table__element-row selectable  {{
        el.daysSinceCreatedAt > 60 && el.estado === 'PENDIENTE' ? 'unselectable' : ''
      }}"
            [class.gcm-table__expanded-row]="expandedElement === el"
            (click)="expandedElement = expandedElement === el ? null : el; $event.stopPropagation()"
          ></tr>
        </table>
        <gcm-table-no-records
          [isLoading]="isLoading"
          [dataSource]="dataSource"
          *ngIf="!dataSource.data.length || !dataSource.filteredData.length || isLoading"
        >
        </gcm-table-no-records>
      </div>
    </mat-tab>
    <mat-tab label="Resultados por pregunta">
      <br />
      <div class="container" *ngIf="grafica">
        <div class="row" *ngFor="let data of grafica.datasetsGrouped; let i = index">
          <div class="col-12 col-lg-9">
            <gcm-stacked-bar
              [data]="data"
              [description]="data.aspecto"
              *ngIf="graficaRegenerada"
            ></gcm-stacked-bar>

            <div class="bdr2-fac-per">
              <div
                [style.width.px]="el === 'CENTRO' ? 220 : 130"
                *ngFor="let el of data.labelsForMiniTable"
              >
                {{el}}
              </div>
            </div>
            <div *ngFor="let el of data.dataForMiniTable; let ix = index">
              <div class="bdr1-fac-per">
                <div style="display: flex; width: 610px; justify-content: space-between">
                  <div style="width: 220px">
                    <b>{{ el['CENTRO'] }}:</b>
                  </div>

                  <div
                    [style.width.px]="el === 'CENTRO' ? 220 : 130"
                    [hidden]="nm === 'CENTRO'"
                    *ngFor="let nm of data.labelsForMiniTable"
                  >
                    <div *ngIf="nm !== 'CENTRO'">{{ el[nm] | formatMoney: false }}</div>
                  </div>
                </div>
              </div>
            </div>
            <br />
            <br />
          </div>
          <div class="col-12 col-lg-3">
            <br />
            <br />
            <div *ngFor="let des of fetchByOrden(data.labels)">
              <span><b>{{des.key}} :</b> {{des.description }}</span><br /><br />
            </div>
          </div>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Resultados generales">
      <br />
      <div class="container" *ngIf="grafica && calificacionesCondiciones">
        <div class="row">
          <div class="col-12 col-md-8">
            <gcm-stacked-bar
              [data]="calificacionesCondiciones"
              description="CALIFICACIÓN POR CONDICIÓN"
              *ngIf="graficaRegenerada"
            ></gcm-stacked-bar>

            <div class="bdr2-fac-per">
              <div style="width: 220px">CENTRO</div>
              <div style="width: 130px">C1</div>
              <div style="width: 130px">C2</div>
              <div style="width: 130px">C3</div>
              <div style="width: 130px">C4</div>
              <div style="width: 130px">C5</div>
              <div style="width: 130px">C6</div>
              <div style="width: 130px">C7</div>
              <div style="width: 130px">TOTAL</div>
            </div>
            <div *ngFor="let el of calificacionesCondiciones.dataForMiniTable; let ix = index">
              <div class="bdr1-fac-per">
                <div style="display: flex; width: 610px; justify-content: space-between">
                  <div style="width: 220px">
                    <b>{{ el['nombre'] }}:</b>
                  </div>

                  <div style="width: 130px">{{ el['C1'] | formatMoney: false }}</div>
                  <div style="width: 130px">{{ el['C2'] | formatMoney: false }}</div>
                  <div style="width: 130px">{{ el['C3'] | formatMoney: false }}</div>
                  <div style="width: 130px">{{ el['C4'] | formatMoney: false }}</div>
                  <div style="width: 130px">{{ el['C5'] | formatMoney: false }}</div>
                  <div style="width: 130px">{{ el['C6'] | formatMoney: false }}</div>
                  <div style="width: 130px">{{ el['C7'] | formatMoney: false }}</div>
                  <div style="width: 130px">{{ el['TOTAL'] | formatMoney: false }}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <br />
            <div *ngFor="let i of calificacionesCondiciones.labelsNames">
              <span><b>{{i.value}}</b> - {{i.name}}</span><br /><br />
            </div>
          </div>
        </div>
      </div>

      <br />

      <div class="container" *ngIf="grafica && calificacionesGenerales">
        <div class="row">
          <div class="col-12">
            <gcm-stacked-bar
              [data]="calificacionesGenerales"
              description="CALIFICACIÓN POR ENTIDAD"
              *ngIf="graficaRegenerada"
            ></gcm-stacked-bar>

            <br />
            <div class="bdr2-fac-per">
              <div style="width: 220px">CENTRO</div>
              <div style="width: 130px">CALIFICACIÓN</div>
            </div>
            <div *ngFor="let el of calificacionesGenerales.dataForMiniTable; let ix = index">
              <div class="bdr1-fac-per">
                <div style="display: flex; width: 610px; justify-content: space-between">
                  <div style="width: 220px">
                    <b>{{ el['nombre'] }}:</b>
                  </div>

                  <div style="width: 130px">{{ el['calificacion'] | formatMoney: false }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</ion-content>
